---
title: "CF using data aggregated by landowner"
author: "Shunkei Kakimoto"
output:
  html_document:
    number_sections: yes
    theme: flatly
    toc_float: yes
    toc: yes
    toc_depth: 3
geometry: margin=1in
---

```{r setup, include=FALSE}
library(knitr)
library(here)

here::i_am("GitControlled/Codes/2_4_cf_analysis_2008_2012.rmd")

# opts_knit$set(root.dir = "")
# opts_knit$set(root.dir = here())

knitr::opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  comment = NA,
  message = FALSE,
  warning = FALSE,
  tidy = FALSE,
  cache.lazy = FALSE,
  #--- figure ---#
  dpi = 400,
  fig.width = 7.5,
  fig.height = 5,
  out.width = "750px",
  out.height = "500px"
)

# /*===== Basic Packages  =====*/
# /*---- Data Wrangling ----*/
library(data.table)
library(tidyverse)
library(DescTools)
library(maps)

# /*---- Visualization ----*/
library(RColorBrewer)
library(patchwork)
library(ggplot2)
library(ggthemes)
library(ggpubr)
library(viridis)
library(grid)
library(gridExtra)
library(GGally)

# /*---- Model Summary ----*/
library(stats)
library(modelsummary)
library(flextable)
library(officer)
library(officedown)
library(gt)
```

# Objective:
+ Remove data on landowners who own a portion of his farmland in both inside and outside of the buffer of LR side. 
+ Aggregate the data to make it to annual water usage data by landowner and conduct CF-analysis. 


## Data

```{r}
# === setup === #
library(here)
source(here("GitControlled/Codes/0_1_ls_packages.R"))
source(here("GitControlled/Codes/0_0_functions.R"))

#/*--------------------------------*/
#' ## Data
#/*--------------------------------*/
# === NRD boundary === #
nrd_boud <- 
 here("Shared/Data/WaterAnalysis/NRD_bd/BND_NaturalResourceDistricts_DNR.shp") %>%
 st_read() %>%
 filter(NRD_Name %in% c("Lower Republican", "Tri-Basin")) %>%
 st_transform(4269)

# === well are located in east side of US Highway 183?  === #
east_or_west <- 
  here("Shared/Data/WaterAnalysis/east_or_west.rds") %>%
  readRDS()


# === Data period: 2008-2015  === #
reg_data_all <- 
  here("Shared/Data/WaterAnalysis/comp_reg_dt.rds") %>%
  readRDS() %>%
  .[,owner_name := paste0(firstname, "_", lastname)] %>%
  .[year %in% 2008:2015 & usage <= 45] %>%
  east_or_west[., on = "wellid"]


# === Data period: 2008-2012 === #
reg_data <- 
  reg_data_all %>%
  .[year %in% 2008:2012]
```

---

# Identify landowners whose farmland locates in both inside and outside of the five-mile buffer

## Identify landowners in LR who have farmlands outside of the buffer

```{r}
# === All Well Data === #
ir_data <- 
  here('Shared/Data/ir_reg.rds') %>%
  readRDS() %>%
  data.table() %>%
  .[source %in% c('Meter','METER','metered') & nrdname %in% c("Lower Republican", "Tri-Basin")] %>%
  .[,owner_name := paste0(firstname, "_", lastname)]
  # .[year %in% 2008:2012]

# --- check: Low_Tri_5mi --- #
ggplot() + 
  geom_sf(data=nrd_boud) +
  geom_sf(data=st_as_sf(ir_data, coords = c("longdd","latdd"), crs = 4269), 
    aes(color=factor(Low_Tri_5mi)), size=0.5)
```


```{r, echo=F}
# total number of farmers:770
# reg_data$owner_name %>% unique() %>% length()

LR_owner_raw <- reg_data[nrdname=="Lower Republican", owner_name] %>% unique()
# length(LR_owner_raw)#387

TB_owner_raw <- reg_data[nrdname=="Tri-Basin", owner_name] %>% unique()
# length(TB_owner_raw)#445

# Both: 62
both <- intersect(LR_owner_raw, TB_owner_raw)
# length(both)

# only in LR: 325
LR <- LR_owner_raw[!LR_owner_raw %in% c(both)]
# length(LR)

# only in TB: 383
TB <- TB_owner_raw[!TB_owner_raw %in% c(both)]
# length(TB)
```

+ **NOTE**:
  * Remember that some farmers own farmlands in both NRDs. We regard those farmlands as if they are owned by two different owners in each NRD.  
    - Total number of landowners in the data (before we exclude some farmers from data): `r reg_data$owner_name %>% unique() %>% length()`:
      + only in LR: `r length(LR)`
      + only in TB: `r length(TB)` 
      + Both: `r length(both)` 

<br>

+ We want to remove only the fields related to farmers who also have farmland outside of the buffer **in LR side**. If we simply use owners' name to filter the data, we might also eliminate the farmland that owner owened in TB. So a special care is required to distinguish those owners who owns multiple fields in both LR and TB.  
  * We use landowner name associated with NRD name (ex. `"Lower Republican ownerA"`)to filter the data.
  
<br>

+ The below creates a list of landowners who own at least one of their farmlands outside of the buffer in LR.

```{r}
outside_5mi_LR <- 
  ir_data %>%
  .[,nrd_owner_name := paste0(nrdname, " ", owner_name) ] %>%
  .[nrdname=="Lower Republican" & Low_Tri_5mi==0, nrd_owner_name] %>%
  unique()
```

<br>

+ Then, in the regression data(2008-2012), create a column of binary index  `both_InOut_5mi_LR` showing whether a landowner has farmlands in both inside and outside of the buffer facing LR so that we can distinguish them later.

<br>

```{r}
# create "both_InOut_5mi" index
reg_data <- 
  reg_data %>% 
  .[,nrd_owner_name := paste0(nrdname, " ", owner_name) ] %>%
  .[, both_InOut_5mi_LR := ifelse(nrd_owner_name %in% outside_5mi_LR, 1, 0)]
```


```{r, echo=F, eval=F}
# total number of farmers in the data: 832
reg_data$nrd_owner_name %>% unique() %>% length()
# LR: 387
reg_data[nrdname=="Lower Republican", nrd_owner_name] %>% unique() %>% length()
# TB: 445
reg_data[nrdname=="Tri-Basin", nrd_owner_name] %>% unique() %>% length()
```

<br>

+ After distinguishing owners who owns multiple fields in both LR and TB, the total number of farmers included in the data turned out to be: `r reg_data$nrd_owner_name %>% unique() %>% length()`:
  * LR: `r reg_data[nrdname=="Lower Republican", nrd_owner_name] %>% unique() %>% length()`
  * TB: `r reg_data[nrdname=="Tri-Basin", nrd_owner_name] %>% unique() %>% length()`

<br>

```{r}
reg_data %>%
  unique(., by="nrd_owner_name") %>%
  .[, .N, by=.(nrdname, both_InOut_5mi_LR) ] %>%
  .[order(nrdname)] %>%
  print()
```

+ The above table shows the number of farmers for each NRD. `both_InOut_5mi_LR=1` indicates the farmers who also owns farmland outside of the 5-mile buffer of LR side, and the number fo those farmers is 81. 
  * Data related to these 81 farmers is removed from the regression data. 
  * The total number of farmers included in the data is 306+445=751. 

<br>


# New Data (Annual water-use data by owner)

## Flow
+ Use the new criteria `both_InOut_5mi_LR` to filter the data. 
+ For LR data, aggregate the annual data by field to annual data by owner. 
+ For TB data, field-level annual data is used. 


```{r}
mod_reg_data <- 
  reg_data[both_InOut_5mi_LR==0,]

# - TB - #
reg_data_TB <- 
  mod_reg_data[nrdname=="Tri-Basin",]

# - LR - #
reg_data_LR <- 
  mod_reg_data[nrdname=="Lower Republican",]
```


## Problem
+ **Which variable should be used for clustering?**
  + I used to use `tr` (combinations of "township" and "range" index).
+ The value of `tr` is not one, if a farmer has farmland across several "range" . 


```{r}
# Ideally, a single farmers have only one single "tr". Check how many of farmers whose farmland is scattered across multiple "tr"

tr_cl <- 
  reg_data_LR %>%
  distinct(nrd_owner_name, tr) %>%
  .[, index := 1,] %>%
  dcast(.,nrd_owner_name ~ tr, value.var = "index") %>%
  replace(is.na(.), 0) %>%
  .[, total := rowSums(.SD), by = nrd_owner_name]

# tr_cl[total>1, ]
```

+ `r tr_cl[total>1, nrd_owner_name] %>% length()` farmers in LR have farmlands across several `tr` segments.

<br>

+ We need some new geographic segmentation index which covers larger area.
  * Alternatives:
    - **County** (**This time, I used county.**)
    - ?

<br>

```{r}
county_cl <- 
  reg_data_LR %>%
  distinct(nrd_owner_name, county) %>%
  .[, index := 1,] %>%
  dcast(.,nrd_owner_name ~ county, value.var = "index") %>%
  replace(is.na(.), 0) %>%
  .[, total := rowSums(.SD), by = nrd_owner_name]

# county_cl[total>1, nrd_owner_name]
county_cl[total>1, ] %>% print()
```

+ Still there are four farmers who have farmland across several counties. 
  * The above table shows whether a farmer has farmland in each of those counties. If farmland located in a county, 1, otherwise 0.


```{r}
ne_county_sf <-  tigris::counties("Nebraska", cb = TRUE, resolution="20m", progress_bar = FALSE) %>%
  dplyr::select(COUNTYFP, NAME) %>%
  filter(NAME %in% str_to_sentence(unique(mod_reg_data$county)))%>%
  st_transform(4269)

county_cl_sf <-
  reg_data_LR %>%
  .[nrd_owner_name %in% county_cl[total>1, nrd_owner_name],] %>%
  distinct(nrd_owner_name, longdd, latdd) %>%
  st_as_sf(., coords = c("longdd","latdd"), crs = 4269)

ggplot()+
  geom_sf(data=ne_county_sf, aes(fill=NAME), alpha=0.6) +
  geom_sf(data=nrd_boud, color="blue", fill=NA) +  
  geom_sf(data=county_cl_sf, size=1)+
  facet_wrap(~nrd_owner_name, ncol=2)

# reg_data_LR %>%
#   .[nrd_owner_name == "Lower Republican John & Ingrid_Tangeman"] %>%
#   distinct(nrd_owner_name, longdd, latdd, .keep_all = TRUE)

# reg_data_LR %>%
#   .[nrd_owner_name == "Lower Republican David_Black"] %>%
#   distinct(nrd_owner_name, longdd, latdd, .keep_all = TRUE)
```

+ Each panel in the figure above shows how farmland of each of those four farmers is distributed. 
  * Interestingly, each of two farm belonging to "Franklin County Farm" locates in TB and LR respectively although they were subjected to the groundwater allocation limit on data.
  
  <br>

  * Each of the farmland of "John & Ingrid_Tangeman" and "David_Black" are far apart, respectively. (Cannot be helped)
    - **"John & Ingrid_Tangeman"** farmland: Furnas county
      + because the irrigated acres in the farmland in Furnas county is much lager the other one
    - **"David_Black"** farmland: Harlan county 
      + because two out of the three farmland is located in Harlan county
  
  <br>

  * Regarding the farmland of "Franklin County Farm" and " Wayne & Linda_Brummer", it looks okay to regard them as being located in the same county.
    - **"Franklin County Farm"** farmland : Franklin county
    - **"Wayne & Linda_Brummer"** farmland : Harlan county


```{r, results = "hide"}
# reg_data_LR$county %>% unique()

reg_data_LR2 <- 
  reg_data_LR %>%
  .[,county_fix := case_when(
    # - first group - #
    nrd_owner_name == "Lower Republican John & Ingrid_Tangeman" ~ "FURNAS",
    nrd_owner_name == "Lower Republican David_Black" ~ "HARLAN",
    # - second group  - #
    nrd_owner_name == "Lower Republican _Franklin County Farm" ~ "FRANKLIN",
    nrd_owner_name == "Lower Republican Wayne & Linda_Brummer" ~ "HARLAN",
    TRUE ~ county
  )]

# county_cl2 <- 
#   reg_data_LR2 %>%
#   distinct(nrd_owner_name, county_fix) %>%
#   .[, index := 1,] %>%
#   dcast(.,nrd_owner_name ~ county_fix, value.var = "index") %>%
#   replace(is.na(.), 0) %>%
#   .[, total := rowSums(.SD), by = nrd_owner_name]

# county_cl2[total>1, ]
```

+ Now, each farmers in LR have farmland in a single county


## Data aggregation by taking mean values

```{r}
reg_data_LR_mean_final <- 
  reg_data_LR2 %>%
    .[,.(
    usage = mean(usage),
    treat2 = mean(treat2),
    # --- soil --- #
    silttotal_r = mean(silttotal_r),
    claytotal_r = mean(claytotal_r),
    slope_r = mean(slope_r),
    ksat_r = mean(ksat_r),
    awc_r = mean(awc_r),
    # --- weather --- #    
    pr_in = mean(pr_in),
    pet_in = mean(pet_in),
    gdd_in = mean(gdd_in),
    # --- tr --- #
    county = unique(county_fix)
    ), by = .(nrd_owner_name, year)] %>%
    .[,county_year := paste0(county, "_", year)]

reg_data_TB_final <-
  reg_data_TB %>%
  .[, names(reg_data_LR_mean_final) %>% .[-length(.)], with=FALSE] %>%
  .[,county_year := paste0(county, "_", year)]


reg_data_final <- rbind(reg_data_LR_mean_final, reg_data_TB_final)


hist(reg_data_LR_mean_final$usage)
```

---

# CF analysis


## No clustering

```{r, echo=F}
# /*===== control variables =====*/
# remove gdd_in
cov_ls <- c(
  # --- weather --- #
  "pr_in","pet_in",
  # --- soil --- #
  "silttotal_r", "claytotal_r", "slope_r", "ksat_r", "awc_r"
  )

data <- reg_data_final
Y <- data[, usage]
T <- data[, treat2]
X <- data[, ..cov_ls]
cl_var <- data[, county_year] %>% factor()

#/*--------------------------------*/
#' ## 1st CF
#/*--------------------------------*/
set.seed(23456)

forest_W <- regression_forest(
	X, T, 
	num.trees = 4000)
W_hat <- predict(forest_W)$predictions

forest_Y <- regression_forest(
	X, Y, 
	num.trees = 4000)
Y_hat <- predict(forest_Y)$predictions

cf_raw <- causal_forest(
  X=X,
  Y=Y,
  W=T, 
  Y.hat = Y_hat, 
  W.hat = W_hat,
  # clusters = cl_var,
  tune.parameters = "all",
  num.trees = 4000
)

# varimp = variable_importance(cf_raw)
# selected_vars = which(varimp > mean (varimp))
# # selected_vars = which(varimp/mean(varimp) > 0.2)
# se_cov <- data[,cov_ls[selected_vars], with=FALSE]

vis_cf_raw <- gen_impact_viz(
  cf_res= cf_raw,
  data_base=data,
  treat_var='treat2',
  var_ls= cov_ls,
  var_ls_int = cov_ls
)
vis_cf_raw
```

+ **Important variables:**

```{r}
cov_ls[selected_vars] %>% print()
```

## Clustering with `county_year`

```{r, echo=F}
#/*--------------------------------*/
#' ## 1st CF
#/*--------------------------------*/
set.seed(23456)

forest_W_cl <- regression_forest(
  X, T, 
  clusters = cl_var,
  num.trees = 4000)
W_hat <- predict(forest_W_cl)$predictions

forest_Y_cl <- regression_forest(
  X, Y, 
  clusters = cl_var,
  num.trees = 4000)
Y_hat <- predict(forest_Y_cl)$predictions

cf_raw_cl <- causal_forest(
  X=X,
  Y=Y,
  W=T, 
  Y.hat = Y_hat, 
  W.hat = W_hat,
  clusters = cl_var,
  tune.parameters = "all",
  num.trees = 4000
)

varimp = variable_importance(cf_raw_cl)
selected_vars = which(varimp > mean (varimp))
# selected_vars = which(varimp/mean(varimp) > 0.2)
# se_cov <- data[,cov_ls[selected_vars], with=FALSE]

vis_cf_raw_cl <- gen_impact_viz(
  cf_res= cf_raw_cl,
  data_base=data,
  treat_var='treat2',
  var_ls= cov_ls,
  var_ls_int = cov_ls
)
vis_cf_raw_cl
```

+ **Important variable:** 
```{r}
cov_ls[selected_vars]
```

# Next step
<!-- + I think I figure out why we saw non-impact of precipitation when data is aggregated by owner (so each owner has only a single row data) -->
+ The `usge` is the average of water use (acre-inch). 
+ Then, I took a simple average of `usge` by owner
+ So, I'm taking average of average. This could be a problematic if the sizes of farmland owned by the same owner are different because it means the both fields gets the same wight 
+ For example, owner A has two fields:
  * Field 1: area 200 acre, water use 140, so 0.7 acre inch usage
  * Field 2: area 100 acre, water use 50, so 0.2 acre inch usage 
  * Simple average of usage is $\frac{0.7+0.2}{2}=0.45$
  * Using a weighted average, $\frac{200}{200+100}\times0.7 + \frac{100}{200+100}\times0.5=\frac{140+50}{300}=0.63 > 0.45$
  
<br>
+ So I needed to calculate with weighted average (weighted by `acres`). 
  + We have two `i.acres` and `acres` in the data 

+ Need to have correct data. Can I reproduce the data from scratch?




