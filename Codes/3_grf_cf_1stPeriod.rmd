---
title: "Report: Estimating the Impact of Groundwater Allocation Policies on Irrigation Behavior"
author: "Shunkei Kakimoto"
output:
  html_document:
    number_sections: yes
    theme: flatly
    toc_float: yes
    toc: yes
    toc_depth: 3
geometry: margin=1in
---

```{r setup, include=FALSE}
library(knitr)
library(here)
here::i_am("GitControlled/Codes/2_grf_cf_analysis.rmd")

opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  message = FALSE,
  warning = FALSE, 
  cache.lazy = FALSE,
  #--- figure ---#
  dpi = 400,
  fig.width = 7.5,
  fig.height = 5,
  out.width = "750px",
  out.height = "500px"
)

# /*===== Basic Packages  =====*/
# /*---- Data Wrangling ----*/
library(data.table)
library(tidyverse)
library(DescTools)
library(maps)

# /*---- Visualization ----*/
library(RColorBrewer)
library(patchwork)
library(ggplot2)
library(ggthemes)
library(ggpubr)
library(viridis)
library(grid)
library(gridExtra)
library(GGally)

# /*---- Model Summary ----*/
library(stats)
library(modelsummary)
library(flextable)
library(officer)
library(officedown)
library(gt)
```

```{r include=F}
library(here)
```




```{r}
# === setup === #
library(here)
source(here("GitControlled/Codes/0_1_ls_packages.R"))
source(here("GitControlled/Codes/0_0_functions.R"))

# /*===== Data =====*/
reg_data_all <- 
  here("Shared/Data/WaterAnalysis/comp_reg_dt.rds") %>%
  readRDS() %>%
  .[year %in% 2008:2015 & usage <= 45,] %>%
  .[,tr_year:=factor(paste0(tr,year))]


reg_data <- 
  reg_data_all %>%
  .[year %in% 2008:2012]

# /*===== Boxplot =====*/
ggplot() +
  geom_boxplot(data = reg_data_all, aes(x=year, y= usage, group= interaction(nrdname, year), fill= nrdname)) +
  geom_hline(yintercept = 9, color="red")

# /*===== How often producer in LR used more than 9 inches  =====*/
ch_reg_data <- 
  reg_data_all %>%
  .[treat2==1,.(ID, year, usage)] %>%
  .[,over_9 := ifelse(usage<=9, 0, 1)] %>%
  .[, .(
    num_obs = .N,
    sum_over_9 = sum(over_9, na.rm=TRUE)
    ), by = year] %>%
  .[,prop_over_9 := sum_over_9/num_obs] %>%
  .[order(year)]

ggplot(ch_reg_data)+
  geom_line(aes(x=year, y=prop_over_9))


```

+ In each year during the 2008-2012, some farmers (approximately 10% of total farmers) in LR used more than 9 inches groundwater.
+ In 2012, the median of water use in LR is `r median(reg_data_all[nrdname=="Lower Republican" & year == 2012, usage])`.
  * How could this be possible? 
+ What are those outliers? 

<br>

+ A farmer in LR received 45 acre-inches (9 acre-inches per year) in total in an allocation period (5 years). 
+ Was a farmer allowed to reallocate total 45 acre-inches freely to any years within 5 years allocation period?

<br>

+ **Pooling Agreement**:
  * An agreement approved by the District between two or more Landowners for the purpose of allocating ground water among the total combined Certified Irrigated Acres identified in such agreement.
    - For example, a farmer A (10 acres) and a farmer B (20 acres) contracted this agreement, then farmer A and B can access to (10 acres + 20 acres) * 9 acre-inches per year= 270 inches per year in total , and they can allocate this amount of water freely between their farmlands. 
+ **Pooling Arrangement**:
  * An arrangement approced by the District by a single landowner to combine more than one tract of land under common ground water among the total combined Certified Irrigated Acres identified in the arrangement. 
    - For example, suppose a farmer has multiple farmlands (field A :10 acres and field B: 20 acres) which are admitted as Certified Irrigated Acres. His total groundwater allocation is 270 inches per year in total ((10 acres + 20 acres) * 9 acre-inches per year= 270), and he can allocate this amount of groundwater to field A and field B freely.  
+ These mean that use of well-level data to estimate treatment effects is not correct? (It depends on how many of farmers in LR used Pooling Agreement/Arrangement.)

<br>

+ In LR, more than 13,000 irrigated acres (4% of the total irrigated acres in LR) have been permanently or temporarily retired with participation in federal and state conversation programs designed to reduce water use.  
  * This means that 



```{r}
survive_trt_group <- 
  # reg_data_all %>%
  reg_data %>%
  .[nrdname=="Lower Republican", ] %>%
  .[,.(wellid, year)] %>%
  .[,year := paste0("y_", year)] %>%
  .[,data_index := 1] %>%
  dcast(wellid ~ year, value.var = "data_index") 


survive_trt_group[is.na(survive_trt_group)] <- 0

survive_trt_group2 <- 
  copy(survive_trt_group) %>%
  .[, total := rowSums(.SD), by = wellid]


lon_survive_trt_group <- 
   survive_trt_group2[total<=4, !"total"] %>%
   .[,id := seq(from=10, by=100, length.out = nrow(.))] %>%
   melt(id.vars = c("wellid", "id"), measure.vars = names(.)[-c(1,7)])

ggplot(lon_survive_trt_group, aes(x = variable, y = id, group = id, col = factor(value)))+
  geom_line(size = 0.5) +
  geom_point(shape = 15, size = 0.5)

lon_survive_trt_group3 <- 
   copy(survive_trt_group2) %>%
   .[total<=4, !"total"] %>%
   .[,survie_index := case_when(
    y_2008==1 & y_2009==1 & y_2010==1 & y_2011==1 & y_2012==0 ~ "f4",
    y_2008==1 & y_2009==1 & y_2010==1 & y_2011==0 & y_2012==0 ~ "f3",
    y_2008==1 & y_2009==1 & y_2010==1 & y_2011==0 & y_2012==0 ~ "f3",
    y_2008==1 & y_2009==1 & y_2010==0 & y_2011==0 & y_2012==0 ~ "f2",
    y_2008==1 & y_2009==0 & y_2010==0 & y_2011==0 & y_2012==0 ~ "f1",
    TRUE ~ "f0"
    )]

lon_survive_trt_group3 %>%
  .[, .N, by = survie_index]

well_f0 <- lon_survive_trt_group3[survie_index=="f0", wellid]
well_f1 <- lon_survive_trt_group3[survie_index=="f1", wellid]
well_f2 <- lon_survive_trt_group3[survie_index=="f2", wellid]
well_f3 <- lon_survive_trt_group3[survie_index=="f3", wellid]
well_f4 <- lon_survive_trt_group3[survie_index=="f4", wellid]

dt_f1 <- 
  copy(reg_data) %>%
  .[, idn :=case_when(
      wellid %in% well_f1 ~ "f1",
      wellid %in% well_f2 ~ "f2",
      wellid %in% well_f3 ~ "f3",
      wellid %in% well_f4 ~ "f4",
      wellid %in% well_f0 ~ "f0"
      )]


dt_f1[idn != "f0"] %>%
  ggplot() +
  geom_line(aes(x=year, y=usage, group = wellid, color=factor(wellid)))+
  geom_line(aes(x=year, y=usage, group = wellid, color=factor(wellid)))+
  facet_wrap( ~ idn, ncol=2)
```

























