---
title: "CF analysis, 5 miles, Aggregated Data"
author: "Shunkei Kakimoto"
output:
  html_document:
    number_sections: yes
    theme: flatly
    toc_float: yes
    toc: yes
    toc_depth: 3
geometry: margin=1in
---

```{r setup, include=FALSE}
library(knitr)
library(here)

here::i_am("GitControlled/Codes/2_2_1_CF_5mi_agg.rmd")

# opts_knit$set(root.dir = "")
# opts_knit$set(root.dir = here())

knitr::opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  comment = NA,
  message = FALSE,
  warning = FALSE,
  tidy = FALSE,
  cache.lazy = FALSE,
  #--- figure ---#
  dpi = 400,
  fig.width = 7.5,
  fig.height = 5,
  out.width = "750px",
  out.height = "500px"
)

# /*===== Basic Packages  =====*/
# /*---- Data Wrangling ----*/
library(data.table)
library(tidyverse)
library(DescTools)
library(maps)

# /*---- Visualization ----*/
library(RColorBrewer)
library(patchwork)
library(ggplot2)
library(ggthemes)
library(ggpubr)
library(viridis)
library(grid)
library(gridExtra)
library(GGally)

# /*---- Model Summary ----*/
library(stats)
library(modelsummary)
library(flextable)
library(officer)
library(officedown)
library(gt)

```

```{r, echo=F}
map_theme <-
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank()
  )
```

```{r, echo=F}
# === setup === #
library(here)
source(here("GitControlled/Codes/0_1_ls_packages.R"))
source(here("GitControlled/Codes/0_0_functions.R"))
```


# Objectives
+ Using well data in the 10 miles buffer, do CF analysis with:
  * Cross-sectional data 
    - For LR data, owner-level
    - For TB data, well-level


# Data

```{r}
reg_data_5mi_raw <- 
  here("Shared/Data/WaterAnalysis/reg_data_5mi_raw.rds") %>%
  readRDS()

# - Data on TB - #
TB_5mi <- reg_data_5mi_raw[nrdname=="Tri-Basin",]
# - Data on LR - #
LR_5mi <- reg_data_5mi_raw[nrdname=="Lower Republican",]
```

+ The cross-sectional unit is:
  * For LR data, owner
  * For TB data, well-id
+ About `tr=="5_22"`
  * In these areas in TB, 9 acre-inches regulation has started from 2009 (the second year of the allocation period 2008-2012) 
    - two options for those data points
      + remove entire data points related to `tr=="5_22"`
      + use only the data points starting from 2009

## Aggragate panel data to cross sectional data

### LR data

```{r}
LR_5mi_y_owner <-
  LR_5mi %>%
  .[,.(
    usage = weighted.mean(usage, acres/sum(acres)),
    treat2 = mean(treat2),
    # --- soil --- #
    silttotal_r = weighted.mean(silttotal_r, acres/sum(acres)),
    claytotal_r = weighted.mean(claytotal_r, acres/sum(acres)),
    slope_r = weighted.mean(slope_r, acres/sum(acres)),
    ksat_r = weighted.mean(ksat_r, acres/sum(acres)),
    awc_r = weighted.mean(awc_r, acres/sum(acres)),
    # --- weather --- #    
    pr_in = weighted.mean(pr_in, acres/sum(acres)),
    pet_in = weighted.mean(pet_in, acres/sum(acres)),
    gdd_in = weighted.mean(gdd_in, acres/sum(acres)),
    # --- tr --- #
    cntyname_fix = unique(cntyname_fix)
  ), by = .(nrd_owner_name, year)]

LR_5mi_owner <- 
  LR_5mi_y_owner %>%
  .[,.(
  usage =  sum(usage),
  treat2 = mean(treat2),
  # --- soil --- #
  silttotal_r = mean(silttotal_r),
  claytotal_r = mean(claytotal_r),
  slope_r = mean(slope_r),
  ksat_r = mean(ksat_r),
  awc_r = mean(awc_r),
  # --- weather --- #  
  pr_in = sum(pr_in),
  pet_in = sum(pet_in),
  gdd_in = sum(gdd_in),
  # --- tr --- #
  cntyname = unique(cntyname_fix)
  ), by = .(nrd_owner_name)] %>%
  .[,nrd_owner_name := NULL]

```

### TB data

```{r}
TB_5mi_well <-
  TB_5mi %>%
  # remove data points related to tr=="5_22"
  .[tr!="5_22",] %>%
  .[,.(
  usage = sum(usage),
  treat2 = mean(treat2),
  # --- soil --- #
  silttotal_r = mean(silttotal_r),
  claytotal_r = mean(claytotal_r),
  slope_r = mean(slope_r),
  ksat_r = mean(ksat_r),
  awc_r = mean(awc_r),
  # --- weather --- #  
  pr_in = sum(pr_in),
  pet_in = sum(pet_in),
  gdd_in = sum(gdd_in),
  # --- tr --- #
  cntyname = unique(cntyname)
  ), by = .(wellid)] %>%
  .[, names(LR_5mi_owner), with=FALSE]
```

### Regression data

```{r}
reg_data_5mi <- bind_rows(LR_5mi_owner, TB_5mi_well)
```

## CF Analysis

```{r, echo=F}
# /*===== control variables =====*/
# remove gdd_in
cov_ls <- c(
  # --- weather --- #
  "pr_in","pet_in",
  # --- soil --- #
  "silttotal_r", "claytotal_r", "slope_r", "ksat_r", "awc_r"
  )

data <- reg_data_5mi
Y <- data[, usage]
T <- data[, treat2]
X <- data[, ..cov_ls]
cl_var <- data[, cntyname] %>% factor()
```

### 1st CF

```{r, echo=F}
#/*--------------------------------*/
#' ## 1st CF
#/*--------------------------------*/
set.seed(23456)

forest_W_cl <- regression_forest(
  X, T, 
  clusters = cl_var,
  num.trees = 4000)
W_hat <- predict(forest_W_cl)$predictions

forest_Y_cl <- regression_forest(
  X, Y, 
  clusters = cl_var,
  num.trees = 4000)
Y_hat <- predict(forest_Y_cl)$predictions

cf_raw_cl <- causal_forest(
  X=X,
  Y=Y,
  W=T, 
  Y.hat = Y_hat, 
  W.hat = W_hat,
  clusters = cl_var,
  tune.parameters = "all",
  num.trees = 4000
)

varimp = variable_importance(cf_raw_cl)
selected_vars = which(varimp > mean (varimp))
# selected_vars = which(varimp/mean(varimp) > 0.2)
se_cov <- data[,cov_ls[selected_vars], with=FALSE]

vis_cf_raw_cl <- gen_impact_viz(
  cf_res= cf_raw_cl,
  data_base=data,
  treat_var='treat2',
  var_ls= cov_ls,
  var_ls_int = cov_ls
)
vis_cf_raw_cl
```

# Use owner or well level data that has complete 5 years (from 2008-2012)

```{r}
# === LR === #
check_comp_LR <- 
  LR_5mi_y_owner[,.(nrd_owner_name, year)] %>%
  .[,index := 1] %>%
  dcast(nrd_owner_name ~ year, value.var = "index") %>%
  imputeTS::na_replace(fill = 0) %>%
  .[, num_y := rowSums(.SD), by = nrd_owner_name]

check_comp_LR[, .N, by = num_y] %>% .[order(num_y)] %>% print()

all_y_LR_owner <- check_comp_LR[num_y==5, nrd_owner_name]

```


```{r}
# === TB === #
check_comp_TB <- 
  TB_5mi %>%
  .[tr!="5_22", .(wellid, year)] %>%
  .[,index := 1] %>%
  dcast(wellid ~ year, value.var = "index") %>%
  imputeTS::na_replace(fill = 0) %>%
  .[, num_y := rowSums(.SD), by = wellid]

check_comp_TB[, .N, by = num_y] %>% .[order(num_y)] %>% print()

all_y_TB_owner <- check_comp_TB[num_y==5, wellid]
```


```{r}
# === LR === #
LR_5mi_owner_comp <- 
  LR_5mi_y_owner[nrd_owner_name %in% all_y_LR_owner,] %>%
  .[,.(
  usage =  sum(usage),
  treat2 = mean(treat2),
  # --- soil --- #
  silttotal_r = mean(silttotal_r),
  claytotal_r = mean(claytotal_r),
  slope_r = mean(slope_r),
  ksat_r = mean(ksat_r),
  awc_r = mean(awc_r),
  # --- weather --- #  
  pr_in = sum(pr_in),
  pet_in = sum(pet_in),
  gdd_in = sum(gdd_in),
  # --- tr --- #
  cntyname = unique(cntyname_fix)
  ), by = .(nrd_owner_name)] %>%
  .[,nrd_owner_name := NULL]

# === TB === #
TB_5mi_well_comp <-
  TB_5mi[wellid %in% all_y_TB_owner,] %>%
  .[,.(
  usage = sum(usage),
  treat2 = mean(treat2),
  # --- soil --- #
  silttotal_r = mean(silttotal_r),
  claytotal_r = mean(claytotal_r),
  slope_r = mean(slope_r),
  ksat_r = mean(ksat_r),
  awc_r = mean(awc_r),
  # --- weather --- #  
  pr_in = sum(pr_in),
  pet_in = sum(pet_in),
  gdd_in = sum(gdd_in),
  # --- tr --- #
  cntyname = unique(cntyname)
  ), by = .(wellid)] %>%
  .[, names(LR_5mi_owner), with=FALSE]

```


## Regression data

```{r}
reg_data_5mi_comp <- bind_rows(LR_5mi_owner_comp, TB_5mi_well_comp)
```

## CF Analysis

```{r, echo=F}
# /*===== control variables =====*/
# remove gdd_in
cov_ls <- c(
  # --- weather --- #
  "pr_in","pet_in",
  # --- soil --- #
  "silttotal_r", "claytotal_r", "slope_r", "ksat_r", "awc_r"
  )

data <- reg_data_5mi_comp
Y <- data[, usage]
T <- data[, treat2]
X <- data[, ..cov_ls]
cl_var <- data[, cntyname] %>% factor()
```

### 1st CF

```{r, echo=F}
#/*--------------------------------*/
#' ## 1st CF
#/*--------------------------------*/
set.seed(23456)

forest_W_cl <- regression_forest(
  X, T, 
  clusters = cl_var,
  num.trees = 4000)
W_hat <- predict(forest_W_cl)$predictions

forest_Y_cl <- regression_forest(
  X, Y, 
  clusters = cl_var,
  num.trees = 4000)
Y_hat <- predict(forest_Y_cl)$predictions

cf_raw_cl <- causal_forest(
  X=X,
  Y=Y,
  W=T, 
  Y.hat = Y_hat, 
  W.hat = W_hat,
  clusters = cl_var,
  tune.parameters = "all",
  num.trees = 4000
)

varimp = variable_importance(cf_raw_cl)
selected_vars = which(varimp > mean (varimp))
# selected_vars = which(varimp/mean(varimp) > 0.2)
se_cov <- data[,cov_ls[selected_vars], with=FALSE]

vis_cf_raw_cl <- gen_impact_viz(
  cf_res= cf_raw_cl,
  data_base=data,
  treat_var='treat2',
  var_ls= cov_ls,
  var_ls_int = cov_ls
)
vis_cf_raw_cl
```

### 2nd CF

```{r, echo=F}
#/*--------------------------------*/
#' ## 2nd CF
#/*--------------------------------*/
cf_res_cl <- causal_forest(
  X=se_cov,
  Y=Y,
  W=T, 
  Y.hat = Y_hat, 
  W.hat = W_hat,
  clusters = cl_var,
  # sample.fraction = 0.4,
  num.trees = 4000,
  tune.parameters = "all",
  # tune.parameters = c(""),
)

#/*--------------------------------*/
#' ## Visualization
#/*--------------------------------*/
vis_cf_res_cl <-
  gen_impact_viz(
  cf_res= cf_res_cl,
  data_base=data,
  treat_var='treat2',
  var_ls= cov_ls[selected_vars],
  var_ls_int = cov_ls[selected_vars]
)
vis_cf_res_cl
```








